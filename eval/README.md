# How to perform the evaluation

This readme describes the steps necessary to perform the RaaS evaluation. 
A python environment capable of running RaaS is necessary to execute these scripts. 
However, it is likely simpler to install all of the packages imported at the top of the eval.py script. 
Note that 'headless_raas' is not a package, but another script in the directory. 

Collect datasets first using the get_r_dois.py script. 
This script will collect all of the datasets with R scripts that exist on Harvard's Dataverse at the time you run the script. 
It will identify each dataset that the scripts belong to, find the unique doi for each one, and then write those dois to a file r_dois.txt.
To be clear: the dois returned by this script are for datasets NOT R scripts. 
Therefore number of lines in r_dois.txt == number of datasets to evaluate. 
The script will also print the number of R scripts found. 

## Evaluating dataverse as-is without RaaS
The database needs to be created before the eval script is executed. 
The schema is described below.

The schema is:
CREATE TABLE results (
ID INTEGER PRIMARY KEY NOT NULL,
filename TEXT NOT NULL,
error TEXT NOT NULL
);

It is also possible to control which range of dois the script processes by using the --start and --end flags.
This script will use the file 'r_dois.txt' generated by the get_r_dois.py script to determine which datasets to use.
The 'r_dois.txt.' file must be in the same directory as eval.py.
These results will be saved to the results.db database. 

To being the evaluation, run the eval.py script with the --noraas flag (and --start and --end if desired). 
The eval script will download each dataset in batches determine by the variables start, end, and increment_by.
Once it completes downloading it will call a function to asynchronously run those datasets in a r-base 3.6.3 environment.
During this asynchronous execution it will begin to download the next batch. 
This script will collect any errors (if any) that occur when the R scripts are executed in the r-base environment. '


## Evaluating dataverse with RaaS

Before running this evaluation, you must make sure of two things:
First, RaaS must be running. 
The eval will not start RaaS on its own. 
The easiest way to start RaaS is calling docker-compose up --build from the root RaaS directory. 
Note, docker-compose and Docker will need to be installed seperately. 
Check the RaaS wiki on GitHub for more information on installation.
Second, there needs to be an initial user for RaaS.
If there is no user recorded in the database, RaaS will fail. 
A user can easily be created by running RaaS and navigating to the service in a web browser and creating a user. 
If you cannot do that, you can also simply use sqlite3 to add a user by command line. 
Whoever is user at index 1 will have all of the eval datasets associated to their account. 

Like with the noraas option, the r_dois.txt fill will be read to determine what to process and a range of dois can be specified using --start and --end.  

Once these prereqs are met, running the eval is as simple as running `python eval.py`. 
